<Page x:Class="CORCleanup.Views.UninstallerPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:models="clr-namespace:CORCleanup.Core.Models;assembly=CORCleanup.Core"
      Title="Uninstaller"
      Background="{DynamicResource ApplicationBackgroundBrush}">
    <DockPanel Margin="12,0,12,8">
        <!-- Section Header -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,8,0,6">
            <Border Width="4" Height="18" CornerRadius="2"
                    Background="{StaticResource CorSectionUninstallerBrush}" Margin="0,0,8,0" VerticalAlignment="Center" />
            <TextBlock Text="Uninstaller" FontSize="16" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextFillColorPrimaryBrush}" VerticalAlignment="Center" />
        </StackPanel>
        <Grid>
            <Grid.Resources>
                <BooleanToVisibilityConverter x:Key="BoolToVis" />
            </Grid.Resources>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Controls bar -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <ui:Button Grid.Column="0"
                           Content="Load Programmes"
                           Appearance="Primary"
                           Command="{Binding ViewModel.LoadProgramsCommand}"
                           MinWidth="140"
                           Margin="0,0,12,0" />

                <ui:TextBox Grid.Column="1"
                            PlaceholderText="Search by name or publisher..."
                            Text="{Binding ViewModel.SearchFilter, UpdateSourceTrigger=PropertyChanged}" />

                <ui:Button Grid.Column="2"
                           Content="Uninstall Selected"
                           Appearance="Danger"
                           Command="{Binding ViewModel.UninstallSelectedCommand}"
                           MinWidth="140"
                           Margin="12,0,0,0" />
            </Grid>

            <!-- Programme count and selected count -->
            <TextBlock Grid.Row="1"
                       Margin="0,0,0,8"
                       Opacity="0.6"
                       FontSize="12">
                <Run Text="{Binding ViewModel.FilteredPrograms.Count, Mode=OneWay}" />
                <Run Text=" programme(s) shown" />
                <Run Text="  |  " />
                <Run Text="{Binding ViewModel.SelectedCount, Mode=OneWay}" />
                <Run Text=" selected  (Ctrl+Click or Shift+Click for multi-select)" />
            </TextBlock>

            <!-- Programme list — multi-select with Ctrl/Shift click -->
            <DataGrid Grid.Row="2"
                      x:Name="ProgramGrid"
                      ItemsSource="{Binding ViewModel.FilteredPrograms}"
                      SelectionMode="Extended"
                      SelectionChanged="ProgramGrid_SelectionChanged"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      IsReadOnly="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Name"
                                        Binding="{Binding DisplayName}"
                                        Width="*" />
                    <DataGridTextColumn Header="Publisher"
                                        Binding="{Binding Publisher}"
                                        Width="180" />
                    <DataGridTextColumn Header="Version"
                                        Binding="{Binding DisplayVersion}"
                                        Width="100" />
                    <DataGridTextColumn Header="Source"
                                        Binding="{Binding SourceLabel}"
                                        Width="60" />
                    <DataGridTextColumn Header="Size"
                                        Binding="{Binding SizeFormatted}"
                                        Width="80" />
                    <DataGridTextColumn Header="Installed"
                                        Binding="{Binding InstallDateFormatted}"
                                        Width="100" />
                </DataGrid.Columns>
            </DataGrid>

            <!-- Leftover panel — shown after uninstall if leftovers found -->
            <ui:Card Grid.Row="3"
                     Margin="0,8,0,0"
                     Padding="12"
                     Visibility="{Binding ViewModel.HasLeftovers, Converter={StaticResource BoolToVis}}">
                <DockPanel MaxHeight="260">
                    <!-- Leftover header with action buttons -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   FontWeight="SemiBold" FontSize="13"
                                   VerticalAlignment="Center">
                            <Run Text="Leftovers Found — " />
                            <Run Text="{Binding ViewModel.Leftovers.Count, Mode=OneWay}" />
                            <Run Text=" item(s)" />
                        </TextBlock>

                        <ui:Button Grid.Column="1"
                                   Content="Remove Selected"
                                   Appearance="Danger"
                                   Command="{Binding ViewModel.RemoveLeftoversCommand}"
                                   MinWidth="120"
                                   Margin="0,0,8,0" />

                        <ui:Button Grid.Column="2"
                                   Content="Dismiss"
                                   Appearance="Secondary"
                                   Command="{Binding ViewModel.DismissLeftoversCommand}"
                                   MinWidth="80" />
                    </Grid>

                    <!-- Leftover items list -->
                    <DataGrid ItemsSource="{Binding ViewModel.Leftovers}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserSortColumns="True"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <!-- Checkbox — single-click toggle via template column -->
                            <DataGridTemplateColumn Header="" Width="30">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                  HorizontalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Path"
                                                Binding="{Binding Path}"
                                                Width="*"
                                                IsReadOnly="True" />

                            <DataGridTextColumn Header="Type"
                                                Binding="{Binding TypeLabel}"
                                                Width="65"
                                                IsReadOnly="True" />

                            <!-- Confidence badge with colour coding -->
                            <DataGridTemplateColumn Header="Risk" Width="110" IsReadOnly="True">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="4" Padding="6,2" HorizontalAlignment="Left">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="{StaticResource CorSuccessBrush}" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Confidence}"
                                                                     Value="{x:Static models:LeftoverConfidence.Review}">
                                                            <Setter Property="Background" Value="{StaticResource CorWarningBrush}" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Confidence}"
                                                                     Value="{x:Static models:LeftoverConfidence.Caution}">
                                                            <Setter Property="Background" Value="{StaticResource CorDangerBrush}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding ConfidenceLabel}" FontSize="11" Foreground="White" />
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Size"
                                                Binding="{Binding SizeFormatted}"
                                                Width="80"
                                                IsReadOnly="True" />
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </ui:Card>

            <!-- Status bar -->
            <TextBlock Grid.Row="4"
                       Text="{Binding ViewModel.StatusText}"
                       Opacity="0.6"
                       FontSize="12"
                       Margin="0,8,0,0" />
        </Grid>
    </DockPanel>
</Page>
